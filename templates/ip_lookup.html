<div>
    {% include "input_form.html" %}
    {% if not ip_list %}
    <div class="table-wrapper">
        {% include "nodata.html" %}
    </div>
    {% else %}
    <table class="table table-striped ip-lookup-table"
        data-toggle="table"
        data-search="true"
        data-buttons-class="outline-secondary"
        data-show-export="true"
        data-show-columns="true"
        data-show-search-clear-button="true">
        <thead>
            <tr class="text-center">
                <th data-sortable="true">Serial Number</th>
                <th data-sortable="true">IP</th>
                <th>Login Name</th>
                <th>BMC Password</th>
                <th>BIOS Ver.</th>
                <th>BMC Ver.</th>
            </tr>
        </thead>
        <tbody>
            {% for item in ip_list %}
            <tr class="text-center">
                <td>{{ item["system_sn"] }}</td>
                <td>{{ item["ip_address"] }}
                    {% if item["ip_address"] != "NA" %}
                    <a href="http://{{ item['ip_address'] }}" target="_blank">
                        <i class="bi bi-link-45deg"></i></a>
                    {% endif %}
                </td>
                <td>{{ item["username"] }}</td>
                <td class="user-select-all">{{ item["password"] }}</td>
                <td>
                    <i class="bi bi-cloud-arrow-down bdownload"></i>
                    <span
                        class="spinner-border spinner-border-sm spinner mx-auto"
                        style="display: none;"></span>
                    <span class="get-bios-ver"></span>
                </td>
                <td>
                    <i class="bi bi-cloud-arrow-down ipmidownload"></i>
                    <span
                        class="spinner-border spinner-border-sm spinner mx-auto"
                        style="display: none;"></span>
                    <span class="get-ipmi-ver"></span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        /**
         * Fetch BIOS and BMC version from the server. 
         */
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector(".ip-lookup-table").addEventListener("click", function(event) {
                const target = event.target;
                if (target.classList.contains("bdownload") || target.classList.contains("ipmidownload")) {
                    const row = target.closest("td");
                    const spinner = row.querySelector(".spinner");
                    const versionSpan = target.classList.contains("bdownload") ? row.querySelector(".get-bios-ver") : row.querySelector(".get-ipmi-ver");
                    const url = target.classList.contains("bdownload") ? "/get_bios_ver" : "/get_ipmi_ver";
    
                    spinner.style.display = "block";
                    target.style.display = "none";
                    versionSpan.textContent = "";
    
                    fetch(url)
                        .then(response => response.text())
                        .then(data => {
                            setTimeout(() => {
                                spinner.style.display = "none";
                                versionSpan.textContent = data;
                            }, 1000);
                        });
                }
            });
        });
    
    </script>
    {% endif %}
</div>
